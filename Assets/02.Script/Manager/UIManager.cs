using System;
using UnityEngine;
using static GameEndContainer;

public class UIManager : Singleton<UIManager> {
    [SerializeField] ScoreContainer scoreContainer;
    [SerializeField] ClockContainer clockContainer;
    [SerializeField] FeverContainer feverContainer;
    [SerializeField] GameEndContainer gameEndContainer;
    [SerializeField] ResumeProductionContainer resumeProductionContainer;

    private void Start() {

        #region 이벤트 등록
        // 플레이어 사망 이벤트
        EventBusManager.Instance.Subscribe<PlayerDeathEvent>(_=> ShowGameEndView(true)); // 플레이어가 죽을 때 이벤트

        // 게임 클리어 이벤트
        EventBusManager.Instance.Subscribe<GameClearEvent>(_ => ShowGameEndView(false)); // 게임 클리어 이벤트

        // 게임 다시 시작 이벤트
        EventBusManager.Instance.Subscribe<RestartAnimationStartedEvent>(_ => StartRestartEffect()); // 재시작 연출 시작 이벤트
        EventBusManager.Instance.Subscribe<RestartAnimationFinishedEvent>(_ => EndProduction()); // 재시작 연출 종료 이벤트

        // 게임 오버 이벤트
        EventBusManager.Instance.Subscribe<GameOver_ResetUIEvent>(_ => ResetScore()); // 게임 오버 - 초기화 이벤트
        EventBusManager.Instance.Subscribe<GameOver_ResetUIEvent>(_ => ResetFever()); // 게임 오버 - 초기화 이벤트

        // 피버 이벤트
        EventBusManager.Instance.Subscribe<FeverTimeStartedEvent>(_=> SetFiverState(true)); // 피버 시작 이벤트
        EventBusManager.Instance.Subscribe<FeverTimeFinishedEvent>(_ => SetFiverState(false)); // 피버 종료 이벤트

        // 점수/피버 점수 추가 이벤트
        EventBusManager.Instance.Subscribe<AddScoreEvent>((e) => AddScore(e.Score)); // 피버 시작 이벤트
        EventBusManager.Instance.Subscribe<AddFeverPointEvent>((e) => AddFeverPoint(e.Score)); // 피버 종료 이벤트
        #endregion

    }

    // 기능 처리
    // 점수 컨테이너
    public void AddScore(int score) => scoreContainer.AddScore(score); // 점수 추가
    public void ResetScore() => scoreContainer.ResetScore(); // 점수 추가
    public int GetScore() => scoreContainer.GetScore(); // 점수 반환
    public void SetFiverState(bool isFeverde) => scoreContainer.SetFiverState(isFeverde); // 피버 상태 토글

    // 시간 컨테이너
    public void UpdateClock(float time) => clockContainer.UpdateClock(time); // 시간 갱신
    public float GetMaxGameTime() => clockContainer.GetMaxGameTime(); // 최대 게임 시간 반환

    // 피버 컨테이너
    public void AddFeverPoint(int addPoint) => feverContainer.AddFeverPoint(addPoint); // 피버 포인트 추가
    public void ResetFever() => feverContainer.ResetFever(); // 피버 초기화
    
    // 게임 엔딩 컨테이너
    private void ShowGameEndView(bool isGameOver) { // 게임 엔딩 뷰 활성화
        var gameEndType = isGameOver ? GameEndType.GameOver : GameEndType.GameClear;
        gameEndContainer.gameObject.SetActive(true);
        gameEndContainer.GameEndInitialize(gameEndType);
    }

    // resumeProduction 컨테이너
    private void StartRestartEffect() => resumeProductionContainer.gameObject.SetActive(true);
    private void EndProduction() => resumeProductionContainer.EndProduction();
}
